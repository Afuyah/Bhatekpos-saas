{% extends 'base_layout.html' %}

{% block title %}
Bhatek - Point of Sale System
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 dark:from-gray-900 dark:via-blue-900 dark:to-indigo-900 flex flex-col items-center justify-center transition-all duration-500 p-4 sm:p-6 lg:p-8 relative overflow-hidden">

  <!-- Animated Background Elements -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -right-40 w-80 h-80 bg-blue-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob dark:bg-blue-800 dark:opacity-30"></div>
    <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-indigo-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000 dark:bg-indigo-800 dark:opacity-30"></div>
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 h-80 bg-purple-200 rounded-full mix-blend-multiply filter blur-xl opacity-50 animate-blob animation-delay-4000 dark:bg-purple-800 dark:opacity-20"></div>
  </div>

  <!-- Security Status Indicator -->
  <div class="absolute top-4 right-4 z-20">
    <div class="flex items-center space-x-2 bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg rounded-full px-3 py-2 shadow-lg border border-green-200 dark:border-green-800/50">
      <div class="relative flex h-2 w-2">
        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
        <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
      </div>
      <span class="text-xs font-medium text-green-700 dark:text-green-400">Secure Connection</span>
    </div>
  </div>

  <!-- Main Content Container -->
  <div class="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-3 gap-8 relative z-10">
    
    <!-- Left Panel - Branding & Noticeboard -->
    <div class="lg:col-span-1 flex flex-col space-y-8">
      <!-- Branding -->
      <div class="text-center lg:text-left">
        <div class="flex items-center justify-center lg:justify-start space-x-4 mb-6">
          <div class="relative">
            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-600 to-indigo-700 flex items-center justify-center shadow-xl transform hover:scale-105 transition-transform duration-300">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
              </svg>
            </div>
            <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl blur opacity-30 animate-pulse"></div>
          </div>
          <div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-700 to-indigo-800 dark:from-blue-400 dark:to-indigo-300 bg-clip-text text-transparent">Bhatek</h1>
            <p class="text-sm text-blue-600 dark:text-blue-400 font-medium">POS System</p>
          </div>
        </div>
        
        <h2 class="text-2xl lg:text-3xl font-bold text-gray-800 dark:text-white mb-4">
          Streamlined 
          <span class="bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-400 dark:to-indigo-400 bg-clip-text text-transparent"> Retail Operations</span>
        </h2>
        <p class="text-gray-600 dark:text-gray-300 text-sm lg:text-base leading-relaxed">
          Point-of-sale system designed for modern retail businesses. 
          Manage inventory, process sales, and track performance in one place.
        </p>
      </div>

      <!-- Noticeboard -->
      <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg rounded-2xl shadow-lg p-6 border border-white/20 dark:border-gray-700/50 transition-all duration-300 hover:shadow-xl">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
            </svg>
            Noticeboard
          </h3>
          <span class="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 rounded-full font-medium">
            Latest
          </span>
        </div>
        <div class="space-y-4">
          {% if notice %}
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4 border border-blue-100 dark:border-blue-800/30">
              <p class="text-sm text-gray-700 dark:text-gray-300">{{ notice }}</p>
              <p class="text-xs text-blue-600 dark:text-blue-400 mt-2">Posted: Today</p>
            </div>
          {% else %}
            <div class="text-center py-8">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 dark:text-gray-600 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
              </svg>
              <p class="text-gray-500 dark:text-gray-400 text-sm">No new notices at the moment</p>
            </div>
          {% endif %}
          
          <!-- System Status -->
          <div class="pt-4 border-t border-gray-200 dark:border-gray-700/50">
            <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-3 flex items-center">
              <span class="relative flex h-2 w-2 mr-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
              </span>
              System Status
            </h4>
            <div class="grid grid-cols-2 gap-3 text-xs">
              <div class="flex items-center text-gray-600 dark:text-gray-400">
                <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                <span>POS Services</span>
              </div>
              <div class="flex items-center text-gray-600 dark:text-gray-400">
                <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                <span>Database</span>
              </div>
              <div class="flex items-center text-gray-600 dark:text-gray-400">
                <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                <span>Payment Gateway</span>
              </div>
              <div class="flex items-center text-gray-600 dark:text-gray-400">
                <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                <span>Inventory Sync</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel - Login Form -->
    <div class="lg:col-span-2">
      <div class="relative">
        <!-- Glass morphism effect -->
        <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-3xl blur-xl opacity-20 dark:opacity-30 transition-all duration-1000"></div>
        
        <!-- Main Login Card -->
        <div class="relative bg-white/90 dark:bg-gray-800/90 backdrop-blur-xl rounded-2xl shadow-2xl overflow-hidden border border-white/20 dark:border-gray-700/50 transition-all duration-500 hover:shadow-2xl">
          
          <!-- Card Header -->
          <div class="relative p-8 text-center border-b border-white/20 bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-700 dark:to-indigo-800">
            <div class="absolute inset-0 bg-gradient-to-r from-white/10 to-transparent"></div>
            <div class="relative z-10">
              <div class="flex justify-center mb-4">
                <div class="flex items-center justify-center w-16 h-16 rounded-2xl bg-white/10 backdrop-blur-sm border border-white/20 transform transition-all duration-300 hover:scale-110 hover:rotate-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                  </svg>
                </div>
              </div>
              <h2 class="text-2xl font-bold text-white mb-2">Secure Login</h2>
              <p class="text-blue-100/90">Enter your credentials to continue</p>
            </div>
          </div>
          
          <!-- Login Form -->
          <form class="p-8 space-y-6" id="login-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <!-- Username/Email -->
            <div class="space-y-2">
              <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                Username or Email
              </label>
              <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-.75m-12 0a2.25 2.25 0 01-2.25-2.25V6.75m12 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                  </svg>
                </div>
                <input id="username" name="username" type="text" required autocomplete="username"
                       class="block w-full pl-10 pr-4 py-3 rounded-xl bg-white/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 backdrop-blur-sm"
                       placeholder="Enter your username or email">
              </div>
            </div>
            
            <!-- Password -->
            <div class="space-y-2">
              <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                Password
              </label>
              <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                  </svg>
                </div>
                <input id="password" name="password" type="password" required autocomplete="current-password"
                       class="block w-full pl-10 pr-12 py-3 rounded-xl bg-white/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 backdrop-blur-sm"
                       placeholder="Enter your password">
                <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-500 dark:hover:text-gray-300 transition-colors">
                  <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                  <svg id="eye-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                  </svg>
                </button>
              </div>
            </div>
            
            <!-- Security Features -->
            <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
              <div class="flex items-center space-x-4">
                <span class="flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Encrypted
                </span>
              </div>
              <div class="text-sm">
                <a href="#" class="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 transition-colors">Forgot password?</a>
              </div>
            </div>
            
            <!-- Submit Button -->
            <div>
              <button type="submit" id="login-button"
                      class="w-full flex justify-center items-center py-3.5 px-4 border border-transparent rounded-xl shadow-lg text-base font-bold text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 group transform hover:scale-[1.02] active:scale-[0.98]">
                Sign In Securely
              </button>
            </div>

            <!-- Error Message Container -->
            <div id="error-message" class="hidden text-red-600 dark:text-red-400 text-sm text-center p-2 rounded-lg bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800/50"></div>
          </form>

          <!-- Security Footer -->
          <div class="px-8 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 text-center border-t border-blue-200 dark:border-blue-800/30">
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 text-xs">
              <div class="flex items-center space-x-4 text-gray-600 dark:text-gray-400">
                <span class="flex items-center">
                  <span class="relative flex h-2 w-2 mr-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                  </span>
                  Secure POS System
                </span>
                <span class="hidden sm:inline">â€¢</span>
                <span>Version 2.4.1</span>
              </div>
              <div class="text-gray-500 dark:text-gray-400">
                Powered by 
                <a href="https://bhatek.space" target="_blank" rel="noopener noreferrer"
                   class="font-medium text-blue-600 dark:text-blue-400 hover:underline">
                   BhaTek Space
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Custom Styles -->
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
  
  body {
    font-family: 'Inter', sans-serif;
  }
  
  .backdrop-blur-sm {
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }
  
  .backdrop-blur-lg {
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
  }
  
  .backdrop-blur-xl {
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
  }
  
  @keyframes blob {
    0% {
      transform: translate(0px, 0px) scale(1);
    }
    33% {
      transform: translate(30px, -50px) scale(1.1);
    }
    66% {
      transform: translate(-20px, 20px) scale(0.9);
    }
    100% {
      transform: translate(0px, 0px) scale(1);
    }
  }
  
  .animate-blob {
    animation: blob 7s infinite;
  }
  
  .animation-delay-2000 {
    animation-delay: 2s;
  }
  
  .animation-delay-4000 {
    animation-delay: 4s;
  }

  /* Subtle button feedback for instant login */
  .login-button-active {
    transform: scale(0.98);
    background: linear-gradient(to right, #3b82f6, #5b21b6);
    box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
  }

  /* Error input highlight */
  .input-error {
    border-color: #ef4444 !important;
    box-shadow: 0 0 8px rgba(239, 68, 68, 0.3) !important;
  }
</style>

<!-- Enhanced JavaScript with Security Features and Instant AJAX Login -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password');
    const usernameInput = document.getElementById('username');
    const togglePassword = document.getElementById('toggle-password');
    const eyeIcon = document.getElementById('eye-icon');
    const eyeOffIcon = document.getElementById('eye-off-icon');
    const loginForm = document.getElementById('login-form');
    const loginButton = document.getElementById('login-button');
    const errorMessage = document.getElementById('error-message');

    // Auto-clear form function
    function clearForm() {
      if (usernameInput) {
        usernameInput.value = '';
        usernameInput.parentElement.classList.remove('input-error');
      }
      if (passwordInput) {
        passwordInput.value = '';
        passwordInput.parentElement.classList.remove('input-error');
      }
      
      // Reset password visibility
      if (passwordInput) passwordInput.type = 'password';
      if (eyeIcon) eyeIcon.classList.remove('hidden');
      if (eyeOffIcon) eyeOffIcon.classList.add('hidden');
      
      // Reset any custom validation
      loginForm.classList.remove('was-validated');
      if (errorMessage) {
        errorMessage.classList.add('hidden');
        errorMessage.textContent = '';
      }
    }

    // Clear form on page load (for when user returns via back button)
    clearForm();

    // Toggle password visibility
    if (togglePassword) {
      togglePassword.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        eyeIcon.classList.toggle('hidden');
        eyeOffIcon.classList.toggle('hidden');
      });
    }

    // Instant AJAX form submission handler
    if (loginForm) {
      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault(); // Prevent default form submission

        // Prevent multiple submissions
        if (loginButton.disabled) return;

        // Brief visual feedback on click
        loginButton.classList.add('login-button-active');
        loginButton.disabled = true;

        // Collect form data
        const formData = new FormData(loginForm);
        const data = {
          username: formData.get('username').trim(),
          password: formData.get('password'),
          csrf_token: formData.get('csrf_token')
        };

        try {
          const response = await fetch('{{ url_for("auth.login") }}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': data.csrf_token
            },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          if (response.ok && result.success) {
            // Successful login, redirect immediately
            window.location.href = result.redirect || '/dashboard';
          } else {
            // Show error message and focus on problematic field
            errorMessage.textContent = result.message || 'Invalid credentials. Please try again.';
            errorMessage.classList.remove('hidden');
            if (result.focus_field === 'username' && usernameInput) {
              usernameInput.parentElement.classList.add('input-error');
              usernameInput.focus();
            } else if (result.focus_field === 'password' && passwordInput) {
              passwordInput.parentElement.classList.add('input-error');
              passwordInput.focus();
            }
            clearForm();
          }
        } catch (error) {
          console.error('Login error:', error);
          errorMessage.textContent = 'An error occurred. Please try again.';
          errorMessage.classList.remove('hidden');
          clearForm();
        } finally {
          // Reset button state
          loginButton.disabled = false;
          loginButton.classList.remove('login-button-active');
        }
      });
    }

    // Add focus effects to form inputs
    const inputs = document.querySelectorAll('input');
    inputs.forEach(input => {
      input.addEventListener('focus', function() {
        this.parentElement.classList.add('ring-2', 'ring-blue-500/20', 'rounded-xl');
        this.parentElement.classList.remove('input-error');
      });
      
      input.addEventListener('blur', function() {
        this.parentElement.classList.remove('ring-2', 'ring-blue-500/20', 'rounded-xl');
      });
    });

    // Auto-clear form when page becomes visible (tab switch)
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        setTimeout(clearForm, 1000);
      }
    });

    // Clear form on page unload (when navigating away)
    window.addEventListener('beforeunload', clearForm);

    // Security: Prevent form autofill from persisting
    if (usernameInput) {
      usernameInput.addEventListener('animationstart', function(e) {
        if (e.animationName === 'autoFillStart') {
          setTimeout(clearForm, 100);
        }
      });
    }

    // Rate limiting: Track failed login attempts
    let loginAttempts = 0;
    const maxAttempts = 5;
    const lockoutTime = 5 * 60 * 1000; // 5 minutes
    const attemptKey = 'bhatek_login_attempts';
    const lockoutKey = 'bhatek_lockout_until';

    // Check for lockout
    const lockoutUntil = localStorage.getItem(lockoutKey);
    if (lockoutUntil && Date.now() < parseInt(lockoutUntil)) {
      const remaining = Math.ceil((parseInt(lockoutUntil) - Date.now()) / 1000);
      errorMessage.textContent = `Too many attempts. Try again in ${remaining} seconds.`;
      errorMessage.classList.remove('hidden');
      loginButton.disabled = true;
      setTimeout(() => {
        localStorage.removeItem(lockoutKey);
        loginButton.disabled = false;
        errorMessage.classList.add('hidden');
      }, remaining * 1000);
    } else {
      localStorage.removeItem(lockoutKey);
      loginAttempts = parseInt(localStorage.getItem(attemptKey)) || 0;
    }

    loginForm.addEventListener('submit', function() {
      if (!loginButton.disabled) {
        loginAttempts++;
        localStorage.setItem(attemptKey, loginAttempts);
        if (loginAttempts >= maxAttempts) {
          const lockoutUntil = Date.now() + lockoutTime;
          localStorage.setItem(lockoutKey, lockoutUntil);
          errorMessage.textContent = `Too many attempts. Please wait 5 minutes.`;
          errorMessage.classList.remove('hidden');
          loginButton.disabled = true;
          setTimeout(() => {
            localStorage.removeItem(lockoutKey);
            localStorage.removeItem(attemptKey);
            loginButton.disabled = false;
            errorMessage.classList.add('hidden');
            loginAttempts = 0;
          }, lockoutTime);
        }
      }
    });

    console.log('Bhatek POS Security: Instant AJAX login, form auto-clear, and client-side rate limiting enabled');
  });
</script>
{% endblock %}